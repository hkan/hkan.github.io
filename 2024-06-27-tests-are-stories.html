<!doctype html>
<html lang="en">
    <head>
  <meta charset="UTF-8" />

  <link rel="canonical" href="/2024-06-27-tests-are-stories" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta
    name="description"
    content="Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show..."
  />

  <meta property="og:site_name" content="Hakan Aktaş" />

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/syntax-highlight.css" />

  
  <meta
    property="og:description"
    content="Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show..."
  />
   
  <meta property="og:title" content="My tests are stories" />
  <meta property="og:type" content="article" />
   
  <meta
    property="article:published_time"
    content="2024-06-27T21:00:00+00:00"
  />
  <meta property="article:author" content="/" />
  

  <meta property="og:url" content="/2024-06-27-tests-are-stories" />

  

  <title>
     My tests are stories
    &mdash; Hakan Aktaş 
  </title>
</head>


    <body class="font-sans bg-stone-50">
        <div class="container max-w-3xl mx-auto">
            <section class="px-4 py-6 mb-6 text-center lg:py-8 lg:-mx-4 lg:mb-10">
  <nav class="flex gap-4 mt-2 text-stone-600 lg:text-lg lg:gap-6 lg:mt-0">
    <a href="/about">About</a>
    <a href="/">Blog</a>
  </nav>
</section>
 <article class="px-4 pb-8 lg:px-0 lg:pb-20">
    <h1 class="text-4xl font-semibold tracking-tight text-stone-700">
        My tests are stories
    </h1>

    <time
        datetime="2024-06-27T21:00:00+00:00"
        class="text-sm text-stone-500"
    >
        
            Published on Thursday, 27 June 2024
        
    </time>

    <div
        class="mt-4 prose lg:mt-8 max-w-none prose-stone prose-headings:text-stone-700 prose-pre:bg-white"
    >
        <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<p>Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show unrealistically simple examples. They tell me how to pass values to a function, and how to assert its return value.</p>

<p>Unit tests have their own qualities, of course. But when I’m building a digital product, I want to have confidence that my app won’t come crashing down. Testing small bits of code in isolation rarely gives me that confidence.</p>

<p>Instead, I write stories. Like children’s stories. Concise, clear, and gives a message at the end.</p>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>There was a category and a checking account that belonged to a knight with a white horse.</p>

  <p>The knight told the accountant they spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty accountant accepted this, and recorded the transaction in their holy book!</p>
</blockquote>

<p>Now, of course I don’t imagine fables like this for every single test I write. That would be totally silly. No sire!</p>

<p>I instead make the story in the language of PHPUnit.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">user_can_create_expense_transaction</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertCreated</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertDatabaseHas</span><span class="p">(</span><span class="nc">Transaction</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It starts by setting up the fairy world, creating the necessary data. Acts the main occasion, the API request. Ends with the moral of the story and the lessons, that the API request has succeeded and the transaction is recorded.</p>

<p>Just for the fun of it, let’s also do a negative outcome story.</p>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>There was a category and a checking account that belonged to a knight with a white horse.</p>

  <p>The ugly witch told the accountant the knight had spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty accountant rejected this, saying they don’t know what knight the witch is talking about.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// Notice the actor is a different, new user</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Each story is one metaphorical page in my [test suite] book.</p>

<h2 id="stories-need-to-be-linear">Stories need to be linear</h2>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p><span class="text-gray-300 line-through">There was a category and a checking account that belonged to a knight with a white horse.</span></p>

  <p>The ugly witch told the accountant the knight had spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty app has rejected this, saying it doesn’t know what knight the witch is talking about.</p>
</blockquote>

<p>This almost makes sense, but with the deleted part, it reads incomplete. Like, what knight? What category?? Even the almighty accountant doesn’t know.</p>

<p>Then I turn a couple pages back to the beginning of the chapter, and notice that the book says…</p>

<blockquote>
  <p>Just so you know, there is a category and a checking account that belonged to a knight with a white horse.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">Category</span> <span class="nv">$category</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">Account</span> <span class="nv">$account</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Between the setUp method above and the test method below, there are</span>
    <span class="c1">// somewhere between 0 and 10s of other methods.</span>
    
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The story is split into parts with different stories in between. I need to jump between the metaphorical pages to see the full picture. Maybe just one page, maybe 10s of pages. My mind struggles to maintain the image of this fairy world.</p>

<p>I instead keep my story in one place, keep it linear, and keep it fluent.</p>

<h2 id="longer-stories-are-fine">Longer stories are fine</h2>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AccountBalanceCalculationTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">future_transactions_affect_account_balance_when_they_are_entered</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$breadCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$aleCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$taxesCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// Income of last harvest season</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="mi">95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 10 on bread</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$breadCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 10 on ale</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$aleCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 15 on taxes</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$taxesCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// *Will* get 90</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// *Will* spend 20 on taxes</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$taxesCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">refresh</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertMoneyEquals</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">);</span>

        <span class="c1">// Travel to after the last transaction should be entered.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">travelTo</span><span class="p">(</span><span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">addMinute</span><span class="p">());</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">artisan</span><span class="p">(</span><span class="nc">EnterTheDueScheduledTransactions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">assertSuccessful</span><span class="p">();</span>

        <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">refresh</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertMoneyEquals</span><span class="p">(</span><span class="mi">135</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Quite the long test method, right? I honestly don’t mind. Even when there are 10s of test methods similar to this.</p>

<p>My monitor fits about 35 lines in the tallest IDE viewport, this example test is 45 lines. Just a tiny bit of scroll does it. Compared to having 30 lines in <code class="language-plaintext highlighter-rouge">setUp</code>, then maybe some collapsed methods, then another 15 lines in the test method; this feels more clear.</p>

<p>I also much rather see directly why the account balance should evaluate to <code class="language-plaintext highlighter-rouge">60 * 100</code>. It’s always more cognitive load if I need to jump between disconnected places in the test code.</p>

<p>In the next section, I will touch upon how to reduce crowd in test methods while still keeping up with the same standards.</p>

<h2 id="abstraction-is-okay-creating-test-data-externally-isnt">Abstraction is okay, creating test data externally isn’t</h2>

<h3 id="prelude-there-are-already-many-abstractions">Prelude: There are already <em>many</em> abstractions</h3>

<ul>
  <li>Database communications are abstracted with Eloquent models, we don’t (usually) write SQL queries.</li>
  <li>No tests ever boot up Laravel, that’s done in <code class="language-plaintext highlighter-rouge">Illuminate\Foundation\Testing\TestCase</code>.</li>
  <li>We don’t use only the most basic <code class="language-plaintext highlighter-rouge">$this-&gt;assertTrue()</code> function, we use assertion functions built upon it.</li>
  <li>In the storytelling metaphor, I didn’t define what a checking account is. I assumed the reader (the test runner) knows that.</li>
</ul>

<h3 id="creating-my-own-abstractions-to-make-tests-even-more-fluent">Creating my own abstractions to make tests even more fluent</h3>

<p>In the same spirit I can make my own abstractions, too. Following up from the last example above, I know transaction creations are roughly the same, and in that whole test class I only care that a transaction exists with a certain amount and on certain dates.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AccountBalanceCalculationTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">future_transactions_affect_account_balance_when_they_are_entered</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$breadCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$aleCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$taxesCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// Past transactions</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="mi">95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>  <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="nv">$account</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="nv">$breadCategory</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="nv">$aleCategory</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="nv">$taxesCategory</span><span class="p">);</span>

        <span class="c1">// Future transactions</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="mi">90</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>  <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nv">$account</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">createTrx</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="nv">$taxesCategory</span><span class="p">);</span>

        <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">refresh</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertMoneyEquals</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertAccountBalanceBecomes</span><span class="p">(</span>
            <span class="mi">135</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="nv">$account</span><span class="p">,</span>
            <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">addMinute</span><span class="p">(),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">createTrx</span><span class="p">(</span>
        <span class="kt">int</span> <span class="nv">$amount</span><span class="p">,</span>
        <span class="kt">Carbon</span> <span class="nv">$date</span><span class="p">,</span>
        <span class="kt">Account</span><span class="o">|</span><span class="nc">Category</span> <span class="nv">$accountOrCategory</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// My test function doesn't need to care what this implementation looks like.</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">assertAccountBalanceBecomes</span><span class="p">(</span>
        <span class="kt">int</span> <span class="nv">$amount</span><span class="p">,</span>
        <span class="kt">Account</span> <span class="nv">$account</span><span class="p">,</span>
        <span class="kt">Carbon</span> <span class="nv">$when</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="c1">// My test function doesn't need to care what this implementation looks like.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now my test method is only 22 lines, but it still ends up doing the exact same work, with the same standards.</p>

<h3 id="model-factories-allow-tests-to-stay-focused-on-data-that-matters">Model factories allow tests to stay focused on data that matters</h3>

<p>You might have noticed that my code mentions an entity called budget. But nowhere in the tests do I create or define it. That’s because a budget’s existence is not immediately relevant to these tests I displayed so far. The budget is created within factories automatically.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AccountFactory</span> <span class="kd">extends</span> <span class="nc">ModelFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">definition</span><span class="p">():</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'budget_id'</span> <span class="o">=&gt;</span> <span class="nc">Budget</span><span class="o">::</span><span class="nf">factory</span><span class="p">(),</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'My budget'</span><span class="p">,</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The awesome <a href="https://laravel.com/docs/11.x/eloquent-factories" target="_blank">Laravel model factories</a> enable me to only create the data I care about in my tests, and it handles all the other necessary data creation for me.</p>

<p>With a good factory setup that covers all models, my tests never have to deal with setting up “base” data.</p>

<h3 id="test-methods-need-to-maintain-control-of-the-world-building">Test methods need to maintain control of the world building</h3>

<p>Implicitly or explicitly, a test method should have complete control over all the data created for its execution.</p>

<p>We have already touched upon implicit data creation just above with factories. Continuing that conversation; even if the test doesn’t create a budget explicitly, it still has complete control over what kind of budget is created. It can always create its own budget instance, and tell <code class="language-plaintext highlighter-rouge">AccountFactory</code> to use it.</p>

<p>What’s <strong>not</strong> ideal is creating anything before or after the test method runs in a common and unspecific place, such as <code class="language-plaintext highlighter-rouge">setUp</code> method. Or worse, in traits’ setup methods, in the extended parent classes like <code class="language-plaintext highlighter-rouge">Tests\TestCase</code>.</p>

<p>Let’s take another look at the example from <em>Stories need to be linear</em> section:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">Category</span> <span class="nv">$category</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">Account</span> <span class="nv">$account</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Between the setUp method above and the test method below, there are</span>
    <span class="c1">// somewhere between 0 and 10s of other methods.</span>
    
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You might have 20 test methods here, all using the exact same category and account creation in them. It might seem very reasonable to centralize them in <code class="language-plaintext highlighter-rouge">setUp</code>.</p>

<p>The problem with that is your individual test methods no longer have control over what accounts and categories exist in their world.</p>

<table>
  <thead>
    <tr>
      <th><span class="italic whitespace-nowrap">“I need to create a new test that …”</span></th>
      <th>With externally created data</th>
      <th>With only internally created data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Needs a single different category to exist in its world</td>
      <td>The new test needs to update the one created outside</td>
      <td>The new test creates the category it needs</td>
    </tr>
    <tr>
      <td>Needs no categories to exist</td>
      <td>The new test needs to remove the one created outside</td>
      <td>The new test creates no categories</td>
    </tr>
    <tr>
      <td>Asserts some category count</td>
      <td>The new test has to account for the category created outside</td>
      <td>The new test doesn’t need to account for categories created outside</td>
    </tr>
  </tbody>
</table>

<p>Also, the test story would start like “there was a category but then it was removed, don’t worry about it”. That’s a terrible story…</p>

<p>Realistically speaking, this may never be a problem with some of my tests. And throughout the lifetime of my app it may never require to be refactored.</p>

<p>When/if I <em>do</em> need to refactor it, however, do I really want to refactor tens of test methods that have no direct relation with the feature I’m building?</p>

<p>And for avoiding duplicating a couple lines of code in each test?</p>

<p>Not worth the terrible story in my opinion.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Tests are the one thing in a software project where I don’t avoid verbosity. This has helped me so far in how I think about my product’s behavior, and in how I describe it as code. The whole test suite paints a clear picture of the software, and I see it as the seedlings of a proper product documentation.</p>

<p>Give it a go sometime for one feature test, and tell me how you feel about it!</p>

<p>You can find me in places via my <a href="/about" target="_blank">about page</a>.</p>
</body></html>

    </div>
</article>

        </div>
    </body>
</html>
