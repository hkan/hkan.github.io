<!doctype html>
<html lang="en">
    <head>
  <meta charset="UTF-8" />

  <link rel="canonical" href="/2024-06-27-tests-are-stories" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta
    name="description"
    content="Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show..."
  />

  <meta property="og:site_name" content="Hakan Aktaş" />

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/syntax-highlight.css" />

  
  <meta
    property="og:description"
    content="Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show..."
  />
   
  <meta property="og:title" content="Tests are stories" />
  <meta property="og:type" content="article" />
   
  <meta
    property="article:published_time"
    content="2024-06-27T21:00:00+00:00"
  />
  <meta property="article:author" content="/" />
  

  <meta property="og:url" content="/2024-06-27-tests-are-stories" />

  

  <title>
     Tests are stories
    &mdash; Hakan Aktaş 
  </title>
</head>


    <body class="font-sans bg-stone-50">
        <div class="container max-w-3xl mx-auto">
            <section class="px-4 py-6 mb-6 text-center lg:py-8 lg:-mx-4 lg:mb-10">
  <nav class="flex gap-4 mt-2 text-stone-600 lg:text-lg lg:gap-6 lg:mt-0">
    <a href="/about">About</a>
    <a href="/">Blog</a>
  </nav>
</section>
 <article class="px-4 pb-8 lg:px-0 lg:pb-20">
    <h1 class="text-4xl font-semibold tracking-tight text-stone-700">
        Tests are stories
    </h1>

    <time
        datetime="2024-06-27T21:00:00+00:00"
        class="text-sm text-stone-500"
    >
        
            Published on Thursday, 27 June 2024
        
    </time>

    <div
        class="mt-4 prose lg:mt-8 max-w-none prose-stone prose-headings:text-stone-700 prose-pre:bg-white"
    >
        <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<p>Because of the way I was repeatedly taught about how to test software, it always confused me. Many lessons out there talk about unit tests, or otherwise show unrealistically simple examples. They tell you how to pass values to a function, and how to assert its return value.</p>

<p>In web application development, that’s rarely what you need from tests to have confidence that your app will not come crashing down.</p>

<p>Instead, you want to write stories. Like children’s stories. Concise, clear, and gives a message at the end.</p>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>There was a category and a checking account that belonged to a knight with a white horse.</p>

  <p>The knight told the accountant they spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty accountant has accepted this, and recorded the transaction in their holy book!</p>
</blockquote>

<p>Now, of course I don’t imagine fables like this for every single test I write. That would be totally silly. No sire!</p>

<p>I instead make the story in the language of PHPUnit.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">user_can_create_expense_transaction</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">budget</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertCreated</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertDatabaseHas</span><span class="p">(</span><span class="nc">Transaction</span><span class="o">::</span><span class="n">class</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It starts by setting up the fairy world, acts the main occasion, and ends with the moral of the story and the lessons.</p>

<p>Just for the fun of it, let’s also do a negative outcome story.</p>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>There was a category and a checking account that belonged to a knight with a white horse.</p>

  <p>The ugly witch told the accountant the knight had spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty accountant has rejected this, saying they don’t know what knight the witch is talking about.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$category</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// Notice the actor is a different, new user</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Each story is one page in your [test suite] book.</p>

<h2 id="stories-need-to-be-unscattered">Stories need to be unscattered</h2>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>The ugly witch told the accountant the knight has spent 10 shillings from the category on that faithful day.</p>

  <p>The almighty app has rejected this, saying it doesn’t know what knight the witch is talking about.</p>
</blockquote>

<p>This makes some sense, but it’s clear <em>something</em> is missing, right? Like, what knight? What category?? Even the almighty accountant doesn’t know.</p>

<p>Then you turn the pages back to the beginning of the chapter, and notice that they said…</p>

<blockquote>
  <p>Just so you know, there is a category and a checking account that belonged to a knight with a white horse.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">Category</span> <span class="nv">$category</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">Account</span> <span class="nv">$account</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Between the setUp method above and the test method below, there are</span>
    <span class="c1">// somewhere between 0 and 10s of other methods.</span>
    
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The story is dispersed to weakly connected pages. You need to jump between pages to see the full picture. Maybe just one page, maybe 10s of pages. Your mind struggles to maintain the image of this fairy world.</p>

<p>Keep your story in one place, and keep it fluent.</p>

<h2 id="longer-stories-are-fine">Longer stories are fine</h2>

<blockquote>
  <p>Once upon a time, there was an almighty accountant. They knew all numbers, they knew everyone’s accounts.</p>

  <p>There was a checking account that belonged to a knight with a white horse.</p>

  <p>The knight had made 95 shillings in the beginning of the harvest season.</p>

  <p>Until the end of the season, the knight had spent 10 shillings on bread, 10 shillings on ale, and 15 shillings on taxes.</p>

  <p>The knight knew he will have to spend another 20 shillings by the next growing season, but also make another 90 until then.</p>

  <p>When the knight asked the accountant what his financial situation is…</p>

  <p>The almighty accountant told him he has 60 shillings now, and will have 135 shillings left for spending until the end of growing season.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AccountBalanceCalculationTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">future_transactions_affect_account_balance_when_they_are_entered</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$breadCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$aleCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
        <span class="nv">$taxesCategory</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// Income of last harvest season</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="mi">95</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 10 on bread</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$breadCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 10 on ale</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$aleCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// Spent 15 on taxes</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$taxesCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">subDays</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// *Will* get 90</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="mi">90</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="c1">// *Will* spend 20 on taxes</span>
        <span class="nc">Transaction</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$account</span><span class="p">,</span> <span class="nv">$taxesCategory</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">([</span>
            <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
        <span class="p">]);</span>

        <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">refresh</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertMoneyEquals</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">);</span>

        <span class="c1">// Travel to after the last transaction should be entered.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">travelTo</span><span class="p">(</span><span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">addDays</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">addMinute</span><span class="p">());</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">artisan</span><span class="p">(</span><span class="nc">EnterTheDueScheduledTransactions</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">assertSuccessful</span><span class="p">();</span>

        <span class="nv">$account</span><span class="o">-&gt;</span><span class="nf">refresh</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertMoneyEquals</span><span class="p">(</span><span class="mi">135</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="n">balance</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Quite the long test method, right? But is it confusing when you read from start to end? I don’t think so.</p>

<p>I much rather see directly in front of my eyes why the account balance came to be <code class="language-plaintext highlighter-rouge">60 * 100</code>. It’s always more cognitive load  if I need to jump between distant places of the code.</p>

<h2 id="abstraction-is-okay-creating-test-data-externally-isnt">Abstraction is okay, creating test data externally isn’t</h2>

<h3 id="your-tests-dont-care-about-every-detail">Your tests don’t care about every detail</h3>

<p>Just like database communications are abstracted to Eloquent models (compared to writing SQL queries), we also defer plenty of other things to some abstractions that run behind the scene.</p>

<ul>
  <li>No tests ever boot up Laravel, for example, that’s done in <code class="language-plaintext highlighter-rouge">Illuminate\Foundation\Testing\TestCase</code>.</li>
  <li>We don’t use only the most basic <code class="language-plaintext highlighter-rouge">$this-&gt;assertTrue()</code> function, we use abstracted assertion logic.</li>
</ul>

<p>In the storytelling metaphor, I didn’t define what a checking account is. I assumed the reader (the test runner) knows that.</p>

<p>–</p>

<p>In the same spirit you can abstract things yourself, too. Maybe you have some specific implementation detail, and you don’t want to have that within your test methods.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ListingCategoriesTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

        <span class="c1">// I'm effectively disabling this listener here, because I don't want</span>
        <span class="c1">// category auto-population in any of the tests here. I want all of</span>
        <span class="c1">// these tests to control what categories exist in the system.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">fake</span><span class="p">(</span><span class="err">\</span><span class="nc">App\Listeners\PopulateCategoriesOfNewBudget</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you have a 3rd party integration and you don’t want to control every bit of the interaction with it, you can abstract it in a way where you only need to define the details you care in test methods.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SomePurchasingFlowTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">failed_payment_is_communicated_to_user</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Test doesn't necessarily care how Stripe is mocked,</span>
        <span class="c1">// so it's abstracted.</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">mockStripePayment</span><span class="p">(</span>
            <span class="n">result</span><span class="o">:</span> <span class="nc">StripeResult</span><span class="o">::</span><span class="nc">PaymentFailed</span><span class="p">,</span>
        <span class="p">);</span>

        <span class="nv">$this</span>
            <span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/purchase'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'products'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="nc">Product</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertPaymentRequired</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>–</p>

<p>You might have also noticed that my code mentions an entity called budget. But nowhere in the test method do I create or define it. That’s because a budget’s existence is not immediately relevant to these test cases I displayed so far. The budget is created in a factory automatically based on the factory definitions.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AccountFactory</span> <span class="kd">extends</span> <span class="nc">ModelFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">definition</span><span class="p">():</span> <span class="kt">array</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'budget_id'</span> <span class="o">=&gt;</span> <span class="nc">Budget</span><span class="o">::</span><span class="nf">factory</span><span class="p">(),</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">faker</span><span class="o">-&gt;</span><span class="nf">words</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The awesome model factories of Laravel enables me to only create the data I care about in my tests, and it handles all the rest of data creation for me.</p>

<p>If another test cares about what specific budget is created, the test explicitly creates it.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CreatingAccountsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">it_rejects_budget_id_of_another_user</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nc">User</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="c1">// I want a specific budget here that is created for the given user.</span>
        <span class="nv">$budget</span> <span class="o">=</span> <span class="nc">Budget</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">recycle</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'v1/accounts'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'Test Account'</span><span class="p">,</span>
                <span class="s1">'budget_id'</span> <span class="o">=&gt;</span> <span class="nv">$budget</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrors</span><span class="p">([</span>
                <span class="s1">'budget_id'</span><span class="p">,</span>
            <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="test-methods-need-to-maintain-control-of-the-world-building">Test methods need to maintain control of the world building</h3>

<p>Implicitly or explicitly, a test method should have complete control over all the data created for its execution.</p>

<p>We have already touched upon implicit data creation just above with factories creating needed data behind the scenes. Continuing that conversation; even if the test doesn’t create a budget explicitly, it still has complete control over what kind of budget is created. It can always create its own budget instance, and tell <code class="language-plaintext highlighter-rouge">AccountFactory</code> to use it.</p>

<p>What’s <strong>not</strong> ideal is creating anything before or after the test method runs in a common and unspecific place, such as <code class="language-plaintext highlighter-rouge">setUp</code> method. Or worse, in traits’ setup methods, in the extended parent classes like <code class="language-plaintext highlighter-rouge">Tests\TestCase</code>.</p>

<p>Let’s take another look at the example from <em>Stories need to be unscattered</em> section:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">AddingTransactionsTest</span> <span class="kd">extends</span> <span class="nc">TestCase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">Category</span> <span class="nv">$category</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">Account</span> <span class="nv">$account</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="nf">setUp</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span> <span class="o">=</span> <span class="nc">Category</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span> <span class="o">=</span> <span class="nc">Account</span><span class="o">::</span><span class="nf">factory</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="k">for</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">budget</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">create</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// Between the setUp method above and the test method below, there are</span>
    <span class="c1">// somewhere between 0 and 10s of other methods.</span>
    
    <span class="c1">#[Test]</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">users_cannot_create_transactions_to_others_accounts</span><span class="p">():</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">actingAs</span><span class="p">(</span><span class="nc">User</span><span class="o">::</span><span class="nf">create</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="nf">postJson</span><span class="p">(</span><span class="s1">'/v1/transactions'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'category_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">category</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'account_id'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">account</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">'amount'</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">,</span>
                <span class="s1">'transaction_date'</span> <span class="o">=&gt;</span> <span class="nf">today</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">format</span><span class="p">(</span><span class="s1">'Y-m-d'</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">assertUnprocessable</span><span class="p">()</span>
            <span class="o">-&gt;</span><span class="nf">assertJsonValidationErrorFor</span><span class="p">(</span><span class="s1">'account_id'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You might have 20 test methods here, all using the exact same category and account creation in them. It might seem very reasonable to centralize them in <code class="language-plaintext highlighter-rouge">setUp</code>.</p>

<p>The problem with that is your individual test methods no longer have control over what accounts and categories exist in their world.</p>

<table>
  <thead>
    <tr>
      <th>Need</th>
      <th>With externally created data</th>
      <th>With only internally created data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>New test that needs a single different category to exist in its world</td>
      <td>It needs to update the one created outside</td>
      <td>It creates the category it needs</td>
    </tr>
    <tr>
      <td>New test that needs no categories to exist</td>
      <td>It needs to remove the one created outside</td>
      <td>It creates no categories</td>
    </tr>
    <tr>
      <td>New test that asserts some category count</td>
      <td>It has to account for the category created outside</td>
      <td>It doesn’t need to account for categories created outside</td>
    </tr>
  </tbody>
</table>

<p>Also, the test story would start like “there was a category but then it was removed, don’t worry about it”. That’s a terrible story…</p>

<p>In the real world, this might not be a problem with some of your tests throughout the lifetime of your software and it might never require to be refactored.</p>

<p>When you <em>do</em> need to refactor it, however, do you really want to refactor tens of test methods that have no direct relation with the feature you’re building?</p>

<p>And what’s the trade we are making here? Avoiding duplicating a couple lines of code in each test? Not worth the bad story if you ask me.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Tests are the one thing in a software project where I intentionally keep things as verbose as necessary. This has helped me so far in how I think about my product’s behavior, and in how I describe it as code. The whole test suit paints a clear picture of the software, and I see it as the seedlings of a proper product documentation.</p>

<p>Give it a go sometime for one feature test, and tell me how you feel about it!</p>

<p>You can find me in places via my <a href="/about" target="_blank">about page</a>.</p>
</body></html>

    </div>
</article>

        </div>
    </body>
</html>
